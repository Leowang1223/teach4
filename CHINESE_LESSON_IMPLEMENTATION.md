# ä¸­æ–‡èª²ç¨‹äº’å‹•æµç¨‹åŠŸèƒ½å¯¦ä½œæ–‡æª”

## å¯¦ä½œæ—¥æœŸ
2025å¹´10æœˆ8æ—¥

## åŠŸèƒ½æ¦‚è¿°
ç‚ºä¸­æ–‡å­¸ç¿’èª²ç¨‹ï¼ˆChinese Lessonsï¼‰å¯¦ä½œå®Œæ•´çš„äº’å‹•å¼å­¸ç¿’æµç¨‹ï¼ŒåŒ…å«é€é¡Œ TTS èªéŸ³æ’­æ”¾ã€å­—å¹•é¡¯ç¤ºã€éŒ„éŸ³è©•ä¼°ã€75åˆ†é€šéæ©Ÿåˆ¶ã€ä»¥åŠå®Œæ•´çš„å­¸ç¿’å ±è¡¨ç”Ÿæˆèˆ‡æ­·å²è¨˜éŒ„æŸ¥è©¢åŠŸèƒ½ã€‚

---

## å·²å¯¦ä½œåŠŸèƒ½

### 1. å­—å¹•æ¬„ UI å…ƒä»¶ âœ…
**æª”æ¡ˆä½ç½®**: `apps/web/src/components/TutorPane/SubtitleBar.tsx`

**åŠŸèƒ½èªªæ˜**:
- åœ¨åœ–ç‰‡ä¸‹æ–¹é¡¯ç¤ºé¡Œç›®æ–‡æœ¬
- æ”¯æ´é‡è©¦ç‹€æ…‹é¡¯ç¤ºï¼ˆã€Œå†ä¾†ä¸€æ¬¡ã€æç¤ºï¼‰
- é¡¯ç¤ºé¼“å‹µæ–‡å­—ï¼ˆé€šéå¾Œæ·¡å…¥å‹•ç•«ï¼‰
- éŸ¿æ‡‰å¼è¨­è¨ˆï¼Œé©é…ä¸åŒè¢å¹•å°ºå¯¸

**ä½¿ç”¨æ–¹å¼**:
```tsx
<SubtitleBar 
  text={currentStep.teacher}
  isRetry={flow.isRetrying}
  encouragement={currentStep.encouragement}
/>
```

---

### 2. ä¸­æ–‡èª²ç¨‹é€é¡Œæµç¨‹æ§åˆ¶ âœ…
**æª”æ¡ˆä½ç½®**: `apps/web/src/lib/useInterviewFlow.ts`

**ä¸»è¦ä¿®æ”¹**:
1. **æ–°å¢ç‹€æ…‹ç®¡ç†**:
   - `isRetrying`: æ¨™è¨˜æ˜¯å¦ç‚ºé‡è©¦ç‹€æ…‹
   - `lastRecordingsRef`: å„²å­˜æ¯é¡Œæœ€å¾Œä¸€æ¬¡éŒ„éŸ³çš„æ•¸æ“šèˆ‡è©•åˆ†

2. **TTS æ’­æ”¾æµç¨‹**:
   - èª²ç¨‹é–‹å§‹æ™‚è‡ªå‹•æ’­æ”¾é¡Œç›®æ–‡æœ¬
   - ä½¿ç”¨ `apiTts` ç²å–èªéŸ³ä¸¦é€é `ttsPlayer` æ’­æ”¾
   - åœ¨å­—å¹•æ¬„åŒæ­¥é¡¯ç¤ºé¡Œç›®æ–‡æœ¬

3. **éŒ„éŸ³èˆ‡è©•ä¼°é‚è¼¯**:
   - ä½¿ç”¨è€…é€éè—è‰²éº¥å…‹é¢¨å…ƒä»¶éŒ„éŸ³
   - éŒ„éŸ³å®Œæˆå¾Œèª¿ç”¨ `apiAnalyze` é€²è¡Œè©•ä¼°
   - å–å¾—è©•åˆ†çµæœï¼ˆ0-100åˆ†ï¼‰

---

### 3. 75åˆ†é€šéæ©Ÿåˆ¶èˆ‡é‡è©¦é‚è¼¯ âœ…
**æª”æ¡ˆä½ç½®**: `apps/web/src/lib/useInterviewFlow.ts` (stopRecording å‡½æ•¸)

**æµç¨‹èªªæ˜**:
```
éŒ„éŸ³å®Œæˆ â†’ STT è½‰æ–‡å­— â†’ èª¿ç”¨ Analysis API è©•åˆ†
    â†“
è©•åˆ† â‰¥ 75 åˆ†ï¼Ÿ
    â”œâ”€ æ˜¯ â†’ å„²å­˜è©•åˆ† â†’ é€²å…¥ä¸‹ä¸€é¡Œ
    â””â”€ å¦ â†’ è¨­å®š isRetrying=true â†’ é¡¯ç¤ºã€Œå†ä¾†ä¸€æ¬¡ã€â†’ é‡æ–°æ’­æ”¾é¡Œç›®
```

**é—œéµä»£ç¢¼**:
```typescript
const PASS_THRESHOLD = 75
if (currentScore >= PASS_THRESHOLD) {
  // é€šéï¼Œé€²å…¥ä¸‹ä¸€é¡Œ
  setIsRetrying(false)
  await playLessonStep(nextLessonIndex, nextStepIndex)
} else {
  // æœªé€šéï¼Œé‡è©¦
  setIsRetrying(true)
  await new Promise(resolve => setTimeout(resolve, 1500))
  await playLessonStep(currentLessonIndex, currentStepIndex)
}
```

---

### 4. å®Œæ•´å ±è¡¨ç”Ÿæˆç³»çµ± âœ…
**æª”æ¡ˆä½ç½®**: `apps/web/src/lib/useInterviewFlow.ts`

**åŠŸèƒ½èªªæ˜**:
- æ‰€æœ‰é¡Œç›®å®Œæˆå¾Œè‡ªå‹•èª¿ç”¨ `apiAnalyze` ç”Ÿæˆå®Œæ•´å ±è¡¨
- æ”¶é›†æ‰€æœ‰èª²ç¨‹æ­¥é©Ÿçš„å•ç­”æ•¸æ“š
- åŒ…å«æ¯é¡Œçš„è©•åˆ†ã€å»ºè­°èˆ‡æ”¹å–„æ–¹å‘
- ä½¿ç”¨æ¯é¡Œæœ€å¾Œä¸€æ¬¡éŒ„éŸ³çš„è©•åˆ†æ•¸æ“š

**å ±è¡¨æ•¸æ“šçµæ§‹**:
```typescript
{
  sessionId: string,
  interviewType: string,
  items: [{
    index: number,
    question: string,
    answer: string,
    lessonId: string,
    stepId: number,
    expectedAnswer: string
  }]
}
```

**å„²å­˜æ©Ÿåˆ¶**:
- å‘¼å« `saveCompleteInterview` å°‡æ•¸æ“šä¿å­˜åˆ°å¾Œç«¯
- åŒ…å«è©•åˆ†ã€è¨ˆæ™‚æ•¸æ“šã€èª²ç¨‹ ID ç­‰å®Œæ•´è³‡è¨Š
- å„²å­˜è‡³ `apps/backend/logs/sessions/` ç›®éŒ„

---

### 5. èª²ç¨‹è¨˜éŒ„æŸ¥è©¢åŠŸèƒ½ âœ…

#### 5.1 å¾Œç«¯ API
**æª”æ¡ˆä½ç½®**: `apps/backend/src/routes/sessions.ts`

**API ç«¯é»**:
1. `GET /api/sessions` - ç²å–æ‰€æœ‰å­¸ç¿’è¨˜éŒ„åˆ—è¡¨
2. `GET /api/sessions/:sessionId` - ç²å–å–®å€‹è¨˜éŒ„è©³æƒ…

**å›å‚³è³‡æ–™**:
```typescript
{
  sessions: [{
    sessionId: string,
    interviewType: string,
    isChineseLesson: boolean,
    lessonId: string,
    createdAt: string,
    completedAt: string,
    completed: boolean,
    totalQuestions: number,
    answeredQuestions: number
  }]
}
```

#### 5.2 å‰ç«¯ UI
**æª”æ¡ˆä½ç½®**: `apps/web/src/app/(protected)/history/page.tsx`

**åŠŸèƒ½ç‰¹è‰²**:
- ğŸ“‹ é¡¯ç¤ºæ‰€æœ‰å­¸ç¿’è¨˜éŒ„ï¼ˆæŒ‰æ™‚é–“å€’åºï¼‰
- ğŸ”„ æŠ˜ç–Š/å±•é–‹æŸ¥çœ‹è©³ç´°è³‡è¨Š
- âœ… å€åˆ†å®Œæˆ/é€²è¡Œä¸­ç‹€æ…‹
- ğŸ“Š ç›´æ¥é€£çµè‡³åˆ†æå ±è¡¨é é¢
- ğŸ‡¨ğŸ‡³ å€åˆ†ä¸­æ–‡èª²ç¨‹èˆ‡é¢è©¦ç·´ç¿’

**UI å…ƒä»¶**:
- èª²ç¨‹å¡ç‰‡ï¼ˆé¡¯ç¤ºæ¨™é¡Œã€æ™‚é–“ã€å®Œæˆç‹€æ…‹ï¼‰
- å±•é–‹è©³æƒ…ï¼ˆSession IDã€å®Œæˆæ™‚é–“ç­‰ï¼‰
- æŸ¥çœ‹å ±è¡¨æŒ‰éˆ•ï¼ˆåƒ…å·²å®Œæˆèª²ç¨‹é¡¯ç¤ºï¼‰
- ç¹¼çºŒå­¸ç¿’æŒ‰éˆ•ï¼ˆé€²è¡Œä¸­èª²ç¨‹é¡¯ç¤ºï¼‰

---

## æª”æ¡ˆä¿®æ”¹æ¸…å–®

### æ–°å¢æª”æ¡ˆ
1. `apps/web/src/components/TutorPane/SubtitleBar.tsx` - å­—å¹•æ¬„ UI å…ƒä»¶
2. `apps/backend/src/routes/sessions.ts` - Session æŸ¥è©¢ API

### ä¿®æ”¹æª”æ¡ˆ
1. `apps/web/src/lib/useInterviewFlow.ts`
   - æ–°å¢ `isRetrying` ç‹€æ…‹
   - æ–°å¢ `lastRecordingsRef` éŒ„éŸ³è¨˜éŒ„
   - ä¿®æ”¹ `stopRecording` å‡½æ•¸ï¼ˆè©•åˆ†èˆ‡é‡è©¦é‚è¼¯ï¼‰
   - ä¿®æ”¹ `saveCompleteInterview` å‡½æ•¸ï¼ˆå„²å­˜è©•åˆ†æ•¸æ“šï¼‰
   - èª²ç¨‹å®Œæˆæ™‚ç”Ÿæˆå®Œæ•´å ±è¡¨

2. `apps/web/src/lib/api.ts`
   - æ–°å¢ `apiAnalyze` - èª¿ç”¨åˆ†æ API
   - æ–°å¢ `apiGetSessions` - ç²å–æ‰€æœ‰è¨˜éŒ„
   - æ–°å¢ `apiGetSessionDetail` - ç²å–å–®å€‹è¨˜éŒ„

3. `apps/web/src/components/TutorPane/index.tsx`
   - æ•´åˆ SubtitleBar å…ƒä»¶
   - æ ¹æ“šèª²ç¨‹é¡å‹é¡¯ç¤ºå­—å¹•æ¬„

4. `apps/backend/src/server.ts`
   - æ–°å¢ `/api/sessions` è·¯ç”±
   - æ–°å¢ `/api/sessions/:sessionId` è·¯ç”±

5. `apps/web/src/app/(protected)/history/page.tsx`
   - å®Œå…¨é‡å¯«ï¼Œå¯¦ä½œå¯¦éš›çš„è¨˜éŒ„æŸ¥è©¢åŠŸèƒ½
   - æ”¯æ´æŠ˜ç–Š/å±•é–‹æŸ¥çœ‹è©³æƒ…
   - é€£çµè‡³åˆ†æå ±è¡¨é é¢

---

## ä½¿ç”¨æµç¨‹

### å­¸ç”Ÿç«¯æµç¨‹
1. **é€²å…¥èª²ç¨‹** â†’ é»æ“Šèª²ç¨‹å¡ç‰‡é€²å…¥å­¸ç¿’é é¢
2. **æ’­æ”¾é¡Œç›®** â†’ è‡ªå‹•æ’­æ”¾ TTS èªéŸ³ï¼Œå­—å¹•æ¬„é¡¯ç¤ºæ–‡æœ¬
3. **éŒ„éŸ³å›ç­”** â†’ é»æ“Šè—è‰²éº¥å…‹é¢¨æŒ‰éˆ•é€²è¡ŒéŒ„éŸ³
4. **è‡ªå‹•è©•åˆ†** â†’ ç³»çµ±è‡ªå‹•è©•ä¼°éŒ„éŸ³ï¼Œçµ¦å‡ºåˆ†æ•¸
5. **é€šé/é‡è©¦**:
   - **â‰¥75åˆ†**: é¡¯ç¤ºé¼“å‹µæ–‡å­—ï¼Œè‡ªå‹•é€²å…¥ä¸‹ä¸€é¡Œ
   - **<75åˆ†**: é¡¯ç¤ºã€Œå†ä¾†ä¸€æ¬¡ã€ï¼Œé‡æ–°æ’­æ”¾é¡Œç›®
6. **å®Œæˆèª²ç¨‹** â†’ ç”Ÿæˆå®Œæ•´å ±è¡¨ä¸¦å„²å­˜
7. **æŸ¥çœ‹å ±è¡¨** â†’ å‰å¾€åˆ†æé é¢æŸ¥çœ‹è©³ç´°è©•åˆ†èˆ‡å»ºè­°
8. **æ­·å²è¨˜éŒ„** â†’ åœ¨ã€Œå­¸ç¿’è¨˜éŒ„ã€é é¢æŸ¥çœ‹æ‰€æœ‰èª²ç¨‹è¨˜éŒ„

### è©•åˆ†é‚è¼¯
- æ¯é¡ŒéŒ„éŸ³å¾Œç«‹å³è©•åˆ†
- è©•åˆ†æ¨™æº–: 0-100 åˆ†
- é€šéé–€æª»: 75 åˆ†
- å„²å­˜: åƒ…ä¿å­˜æ¯é¡Œæœ€å¾Œä¸€æ¬¡ï¼ˆé€šéï¼‰çš„éŒ„éŸ³è©•åˆ†

---

## æŠ€è¡“ç´°ç¯€

### è©•åˆ† API èª¿ç”¨
```typescript
const analysisResult = await apiAnalyze({
  sessionId,
  interviewType,
  items: [{
    index: currentIndex,
    question: currentStep.teacher,
    answer: text,
    lessonId: currentLesson.id,
    stepId: currentStepIndex,
    expectedAnswer: currentStep.expected_answer
  }]
})

const currentScore = analysisResult?.perQuestion?.[0]?.score?.overall || 0
```

### é‡è©¦å»¶é²
- æœªé€šéæ™‚å»¶é² 1.5 ç§’å¾Œé‡æ–°æ’­æ”¾
- é¿å…éå¿«é‡æ’­é€ æˆä½¿ç”¨è€…å›°æƒ‘
```typescript
await new Promise(resolve => setTimeout(resolve, 1500))
```

### éŒ„éŸ³æ•¸æ“šå„²å­˜
```typescript
lastRecordingsRef.current.set(currentIndex, { 
  text: userAnswer, 
  score: finalScore 
})
```

---

## è³‡æ–™åº«çµæ§‹

### Session è¨˜éŒ„æ ¼å¼
```json
{
  "session_id": "1757072483966-i8pzhi",
  "interview_type": "L1",
  "items": [
    {
      "index": 0,
      "question": "In Chinese, we say 'ä½ å¥½ (nÇ hÇo)' which means 'hello'. Please try saying 'ä½ å¥½'.",
      "answer": "ä½ å¥½",
      "lesson_id": "L1",
      "step_id": 0,
      "final_score": 85,
      "askedAt": "2025-10-08T10:30:00.000Z",
      "answeredAt": "2025-10-08T10:30:15.000Z",
      "thinkingTime": 3,
      "answeringTime": 12,
      "completed": false
    },
    ...
  ]
}
```

---

## æ³¨æ„äº‹é …

### UI é™åˆ¶
âœ… **ä¸æ›´æ”¹ç¾æœ‰ UI å…ƒä»¶**
- VoiceDockï¼ˆè—è‰²éº¥å…‹é¢¨ï¼‰ä¿æŒä¸è®Š
- TutorPane ä½ˆå±€ä¿æŒä¸è®Š
- åƒ…æ–°å¢å­—å¹•æ¬„å…ƒä»¶

### è©•åˆ†æ©Ÿåˆ¶
- è©•ä¼°å¤±æ•—æ™‚ä¸æœƒå¡ä½ï¼Œä»æœƒç¹¼çºŒä¸‹ä¸€é¡Œ
- é¿å… API éŒ¯èª¤å°è‡´å­¸ç¿’ä¸­æ–·
```typescript
catch (error) {
  console.error('[Flow] è©•ä¼°å¤±æ•—:', error)
  // è©•ä¼°å¤±æ•—æ™‚ï¼Œä»ç„¶ç¹¼çºŒä¸‹ä¸€é¡Œ
  setIsRetrying(false)
  // ... é€²å…¥ä¸‹ä¸€é¡Œ
}
```

### æ•ˆèƒ½å„ªåŒ–
- ä½¿ç”¨ `useCallback` é¿å…ä¸å¿…è¦çš„é‡æ–°æ¸²æŸ“
- ä½¿ç”¨ `useRef` å„²å­˜æœ€å¾ŒéŒ„éŸ³æ•¸æ“šï¼ˆé¿å… setState å»¶é²ï¼‰
- TTS éŸ³é »å¿«å–æ©Ÿåˆ¶ï¼ˆä¿ç•™ç•¶å‰é¡Œèˆ‡ä¸‹ä¸€é¡Œï¼‰

---

## æ¸¬è©¦å»ºè­°

### åŠŸèƒ½æ¸¬è©¦
1. âœ… é€²å…¥ä¸­æ–‡èª²ç¨‹ï¼ˆL1, L2, etc.ï¼‰
2. âœ… TTS èªéŸ³æ­£å¸¸æ’­æ”¾
3. âœ… å­—å¹•æ¬„æ­£ç¢ºé¡¯ç¤ºé¡Œç›®æ–‡æœ¬
4. âœ… éŒ„éŸ³åŠŸèƒ½æ­£å¸¸
5. âœ… è©•åˆ† â‰¥75 åˆ†æ™‚é€²å…¥ä¸‹ä¸€é¡Œ
6. âœ… è©•åˆ† <75 åˆ†æ™‚é¡¯ç¤ºé‡è©¦æç¤º
7. âœ… æ‰€æœ‰é¡Œç›®å®Œæˆå¾Œç”Ÿæˆå ±è¡¨
8. âœ… æ­·å²è¨˜éŒ„é é¢æ­£ç¢ºé¡¯ç¤ºæ‰€æœ‰èª²ç¨‹
9. âœ… é»æ“Šã€ŒæŸ¥çœ‹å ±è¡¨ã€è·³è½‰è‡³åˆ†æé é¢

### é‚Šç•Œæ¸¬è©¦
- ç¶²è·¯ä¸­æ–·æ™‚çš„éŒ¯èª¤è™•ç†
- API è©•åˆ†å¤±æ•—æ™‚çš„é™ç´šè™•ç†
- ç„¡æ­·å²è¨˜éŒ„æ™‚çš„ç©ºç‹€æ…‹é¡¯ç¤º
- é•·èª²ç¨‹åç¨±çš„ UI é©é…

---

## æœªä¾†æ“´å±•å»ºè­°

### åŠŸèƒ½æ“´å±•
1. **å¤šæ¬¡é‡è©¦è¨˜éŒ„**: è¨˜éŒ„æ¯æ¬¡éŒ„éŸ³çš„è©•åˆ†è®ŠåŒ–
2. **è‡ªè¨‚é€šéé–€æª»**: å…è¨±æ•™å¸«è¨­å®šä¸åŒèª²ç¨‹çš„é€šéåˆ†æ•¸
3. **èªéŸ³å°æ¯”**: æ’­æ”¾æ¨™æº–ç™¼éŸ³èˆ‡å­¸ç”ŸéŒ„éŸ³çš„å°æ¯”
4. **é€²åº¦è¿½è¹¤åœ–è¡¨**: åœ¨æ­·å²è¨˜éŒ„é é¢é¡¯ç¤ºå­¸ç¿’é€²åº¦æ›²ç·š
5. **é›¢ç·šæ¨¡å¼**: æ”¯æ´é›¢ç·šå­¸ç¿’ï¼Œå®Œæˆå¾ŒåŒæ­¥æ•¸æ“š

### æŠ€è¡“å„ªåŒ–
1. **WebSocket å³æ™‚è©•åˆ†**: æ¸›å°‘è©•åˆ†å»¶é²
2. **Service Worker**: å¿«å– TTS éŸ³é »
3. **å¢é‡ä¿å­˜**: æ¯é¡Œå®Œæˆå¾Œç«‹å³ä¿å­˜ï¼Œé¿å…æ•¸æ“šä¸Ÿå¤±
4. **å£“ç¸®éŒ„éŸ³æª”æ¡ˆ**: æ¸›å°‘ä¸Šå‚³æ™‚é–“èˆ‡å„²å­˜ç©ºé–“

---

## ç¸½çµ

æœ¬æ¬¡å¯¦ä½œå®Œæ•´å¯¦ç¾äº†ä¸­æ–‡èª²ç¨‹çš„äº’å‹•å¼å­¸ç¿’æµç¨‹ï¼ŒåŒ…å«ï¼š
- âœ… å­—å¹•æ¬„ UI å…ƒä»¶
- âœ… é€é¡Œ TTS æ’­æ”¾
- âœ… éŒ„éŸ³èˆ‡è‡ªå‹•è©•åˆ†
- âœ… 75åˆ†é€šéæ©Ÿåˆ¶
- âœ… é‡è©¦é‚è¼¯èˆ‡æç¤º
- âœ… å®Œæ•´å ±è¡¨ç”Ÿæˆ
- âœ… æ­·å²è¨˜éŒ„æŸ¥è©¢

æ‰€æœ‰åŠŸèƒ½å·²æ•´åˆè‡³ç¾æœ‰ç³»çµ±ï¼Œä¸å½±éŸ¿åŸæœ‰é¢è©¦åŠŸèƒ½ã€‚ç³»çµ±å…·å‚™è‰¯å¥½çš„éŒ¯èª¤è™•ç†èˆ‡é™ç´šæ©Ÿåˆ¶ï¼Œç¢ºä¿å­¸ç¿’æµç¨‹çš„ç©©å®šæ€§èˆ‡æµæš¢æ€§ã€‚
